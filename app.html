<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SnipBin – Modern Pastebin</title>

<!-- Supabase + Prism -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.js"></script>

<style>
/* fonts & base */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
*{box-sizing:border-box}
body{font-family:"Inter",system-ui,Arial,sans-serif;background:#f5f6fa;margin:0;color:#222;min-height:100vh;display:flex;flex-direction:column}

/* disable selection globally except inputs */
html,body,*{
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
input, textarea, select {
  -webkit-user-select: text;
  user-select: text;
}

/* header */
header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.05);position:relative;z-index:30}
.left-controls{display:flex;align-items:center;gap:10px}

/* logo theme toggle button */
#logoThemeToggle{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:10px;border:0;background:transparent;cursor:pointer}
#logoThemeToggle svg{width:18px;height:18px;display:block}
#logoThemeToggle:hover{background:rgba(0,0,0,0.03)}

/* MENU (garis 3) di header */
#menuBtn{font-size:20px;cursor:pointer;padding:8px;border-radius:10px; user-select: none; display:inline-flex;align-items:center;justify-content:center}
#menuBtn:hover{background:rgba(0,0,0,0.03)}
.brand{display:flex;align-items:center;gap:12px}
/* brand-logo now supports external image with fallback like register */
.brand-logo{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.brand-logo img{width:100%;height:100%;object-fit:contain;display:block}
.brand-logo.dark img{filter:invert(1) brightness(1.6)} /* simple dark tweak */
.brand-logo .logo-fallback{position:absolute;inset:0;display:none;align-items:center;justify-content:center;font-weight:700;color:#4f46e5;background:transparent}
h1{font-size:18px;margin:0;color:#4f46e5;font-weight:700}

/* header buttons */
#profileBtn{cursor:pointer}
#profileBtn img{width:44px;height:44px;border-radius:50%;object-fit:cover;border:2px solid #4f46e5}

/* profile menu */
#profileMenu{position:absolute;top:66px;right:18px;background:#fff;border-radius:12px;box-shadow:0 8px 30px rgba(36,37,38,.08);padding:12px;width:240px;display:none;z-index:60}
#profileMenu p{margin:0 0 8px 0;font-weight:600}
#profileMenu input[type="text"],#profileMenu input[type="file"]{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e6f2;margin-bottom:8px}
#profileMenu button{width:100%;padding:9px;border-radius:8px;border:0;background:#4f46e5;color:#fff;font-weight:600;cursor:pointer}
#profileMenu button.logout{background:#ef4444;margin-top:6px}

/* sidebar */
#sidebar{
  position:fixed;left:-360px;top:0;width:360px;height:100%;background:#fff;border-right:1px solid #f0f0f8;padding:20px;box-shadow:2px 0 24px rgba(0,0,0,.06);transition:left .28s ease;z-index:70;overflow:auto;
  padding-top:60px;
}
#sidebar h2{margin:0 0 12px 0;color:#4f46e5}
#sidebar .subtitle{font-size:13px;color:#666;margin-bottom:12px}

/* tombol back yang diletakkan INSIDE sidebar (logo SVG) */
#sidebarBackBtn{
  position:absolute;
  top:14px;
  left:14px;
  display:none; /* tampil saat sidebar dibuka di Android */
  align-items:center;
  justify-content:center;
  width:42px;
  height:42px;
  padding:6px;
  border-radius:10px;
  border:0;
  background:transparent;
  cursor:pointer;
  user-select:none;
  color:#4f46e5;
  transition:background .16s ease, transform .06s ease;
  z-index:80;
}
#sidebarBackBtn:hover{ background:rgba(79,70,229,0.06); transform:translateX(-2px); }

/* sidebar grid (muncul saat hamburger) */
#sidebarGrid{display:grid;grid-template-columns:1fr;gap:12px}

/* card inside sidebar */
.paste-card{background:#fff;border-radius:10px;padding:12px;border:1px solid #f0f0ff;box-shadow:0 6px 18px rgba(12,13,38,.03);display:flex;flex-direction:column}
.paste-card h3{margin:0 0 8px 0;font-size:14px;color:#333;display:flex;justify-content:space-between;align-items:center}
.paste-card pre{background:#0b1220;color:#e6e6e6;padding:10px;border-radius:8px;overflow:auto;font-size:13px;line-height:1.35;margin:0}
.paste-card .meta{font-size:12px;color:#888;margin-bottom:6px}

/* main container */
.container{max-width:1000px;margin:18px auto;padding:0 20px;flex:1}

/* paste form card */
#pasteForm{background:#fff;padding:18px;border-radius:14px;box-shadow:0 8px 30px rgba(12,13,38,.04);margin-bottom:22px}
.input,textarea,select,button{width:100%;padding:12px;margin-bottom:10px;border-radius:10px;border:1px solid #e7e7f5;font-size:15px}
textarea{min-height:120px;resize:vertical}
button.primary{background:#4f46e5;color:white;border:0;font-weight:700;cursor:pointer}
button.primary:hover{background:#4338ca}

/* icon-only buttons */
.actions{display:flex;gap:8px;align-items:center}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:8px;border-radius:8px;border:0;cursor:pointer;font-weight:600;height:36px;width:36px}
.btn.edit{background:#f59e0b;color:#fff}
.btn.delete{background:#ef4444;color:#fff}
.btn.copy{background:#06b6d4;color:#fff}
.btn.open{background:#10b981;color:#fff}
.btn.eye{background:#6d28d9;color:#fff}
.btn svg{width:18px;height:18px;display:block}
.link-share{color:#4f46e5;text-decoration:none;font-size:13px}

/* overlay view single paste */
#viewOverlay{position:fixed;inset:0;background:rgba(10,11,15,.55);display:none;align-items:center;justify-content:center;z-index:80;padding:20px}
#viewCard{background:#0f1724;color:#fff;max-width:900px;width:100%;Border-radius:12px;border-radius:12px;padding:18px;box-shadow:0 24px 60px rgba(2,6,23,.6)}
#viewCard h2{margin:0 0 6px 0;color:#fff}
#viewCard .meta{font-size:13px;color:#9aa0ad;margin-bottom:10px}
#viewCard pre{background:transparent;padding:12px;border-radius:8px;max-height:60vh;overflow:auto;color:#e6e6e6}

/* toast */
#toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:1000;font-weight:600}

/* footer */
footer{padding:12px 20px;background:transparent;text-align:center;color:#7a7a82;font-size:13px}

/* share modal bottom-sheet */
#shareModal{
  position:fixed;left:0;right:0;bottom:-100%;background:linear-gradient(180deg,#ffffff,#f7f7fb);border-top-left-radius:14px;border-top-right-radius:14px;padding:16px 14px;box-shadow:0 -10px 40px rgba(2,6,23,.18);transition:bottom .28s ease;z-index:140;
  max-width:760px;margin:0 auto;
}
#shareModal.open{bottom:0}
#shareModal .dragger{width:60px;height:6px;background:#d6d6e0;border-radius:8px;margin:6px auto 12px auto;display:block}
#shareModal h3{margin:0 0 8px 0;color:#111;font-size:16px}
.share-grid{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start}
.share-item{width:72px;display:flex;flex-direction:column;align-items:center;gap:8px;text-align:center}
.share-btn{width:56px;height:56px;border-radius:14px;display:flex;align-items:center;justify-content:center;border:0;cursor:pointer;box-shadow:0 6px 18px rgba(12,13,38,.06);background:#fff}
.share-btn img{width:36px;height:36px;object-fit:contain;display:block}
.share-label{font-size:12px;color:#333}

/* icons colors (subtle) */
.icon-bg-copy{background:#e8eef6}
.icon-bg-wa{background:#e6f8ee}
.icon-bg-wab{background:#eef8f2}
.icon-bg-tg{background:#eaf5ff}
.icon-bg-mail{background:#fff3e9}
.icon-bg-dc{background:#f0f0fb}
.icon-bg-fb{background:#e8eefc}

/* small screens */
@media (max-width:760px){
  #sidebar{width:100%;left:-100%}
  #sidebar.open{left:0}
  .share-item{width:20%;min-width:72px}
}
</style>
</head>
<body>

<!-- header -->
<header>
  <div class="left-controls">
    <!-- tombol menu (garis tiga) -->
    <div id="menuBtn" title="Daftar Paste (menu)" role="button" aria-label="Buka menu">☰</div>

    <!-- logo theme toggle (terletak di header, dekat menu) -->
    <button id="logoThemeToggle" title="Toggle logo theme" aria-label="Toggle logo theme" type="button">
      <!-- default icon rendered by JS -->
      <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="4"/></svg>
    </button>
  </div>

  <div class="brand"><div class="brand-logo">
    <!-- external logo image (matching register) with onerror fallback to text -->
    <img id="brandLogoImg" src="https://pomf2.lain.la/f/w53ncnd.png" alt="SnipBin logo" onerror="this.style.display='none'; this.parentElement.querySelector('.logo-fallback').style.display='flex'" />
    <span class="logo-fallback" aria-hidden="true">SB</span>
  </div><h1>SnipBin</h1></div>
  <div id="profileBtn"><img id="profilePic" src="" alt="Profil"/></div>

  <!-- profile dropdown -->
  <div id="profileMenu" aria-hidden="true">
    <p id="profileName">User</p>
    <input id="newName" type="text" placeholder="Ubah nama"/>
    <input id="newPhoto" type="file" accept="image/*"/>
    <button id="saveProfileBtn">Simpan Profil</button>
    <button class="logout" id="logoutBtn">Logout</button>
  </div>
</header>

<!-- sidebar: now contains the paste grid -->
<div id="sidebar" aria-hidden="true">
  <!-- tombol Back di dalam sidebar (ikon SVG) -->
  <button id="sidebarBackBtn" aria-label="Kembali" title="Kembali" type="button">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg">
      <rect x="1.5" y="1.5" width="21" height="21" rx="5" stroke="currentColor" stroke-width="1.6" opacity="0.12"></rect>
      <path d="M14 18l-6-6 6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></path>
    </svg>
  </button>

  <h2>Daftar Paste</h2>
  <div class="subtitle">Menampilkan public + milikmu</div>
  <div id="sidebarGrid"></div>
</div>

<!-- main -->
<div class="container">
  <div id="pasteForm">
    <input id="pasteTitle" class="input" placeholder="Masukkan Judul" />
    <textarea id="pasteContent" placeholder="Tulis/Tempel teks atau kode..."></textarea>
    <select id="pastePrivacy" class="input">
      <option value="public">Public</option>
      <option value="private">Private</option>
    </select>
    <select id="pasteLanguage" class="input">
      <option value="">Plain Text</option>
      <option value="javascript">JavaScript</option>
      <option value="python">Python</option>
      <option value="html">HTML</option>
      <option value="css">CSS</option>
    </select>
    <div style="display:flex;gap:12px">
      <button class="primary" id="savePasteBtn" type="button">Simpan Paste</button>
      <button id="clearFormBtn" type="button">Bersihkan</button>
    </div>
  </div>
</div>

<!-- overlay untuk menampilkan paste tunggal -->
<div id="viewOverlay" role="dialog" aria-modal="true">
  <div id="viewCard">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div>
        <h2 id="viewTitle"></h2>
        <div id="viewDate" class="meta"></div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="viewCopyBtn" class="btn copy" title="Salin" aria-label="Salin" style="background:#06b6d4;color:#fff">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
        </button>

        <!-- share button (modern share icon) -->
        <button id="viewShareBtn" class="btn open" title="Share" aria-label="Share" style="background:#4f46e5;color:#fff">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7"></path>
            <path d="M12 3v10"></path>
            <path d="M8 7l4-4 4 4"></path>
          </svg>
        </button>

        <button id="closeViewBtn" style="background:#ef4444;color:#fff;border:0;padding:8px;border-radius:8px;cursor:pointer">Tutup</button>
      </div>
    </div>
    <pre id="viewContent" class=""></pre>
    <div style="margin-top:12px;display:flex;justify-content:flex-end">
      <!-- fallback: jika user ingin langsung bisa share juga via button -->
      <button id="viewShareInline" class="link-share" style="background:none;border:0;padding:0;cursor:pointer;color:#4f46e5;text-decoration:underline">Share</button>
    </div>
  </div>
</div>

<!-- share modal (bottom sheet) -->
<div id="shareModal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="dragger"></div>
  <h3>Bagikan tautan</h3>
  <div id="shareDesc" style="font-size:13px;color:#666;margin-bottom:10px">Pilih cara membagikan</div>
  <div class="share-grid" id="shareGrid"></div>
  <div style="margin-top:12px;text-align:right">
    <button id="closeShareModal" style="padding:8px 12px;border-radius:8px;border:0;background:#ef4444;color:#fff;cursor:pointer">Tutup</button>
  </div>
</div>

<!-- toast -->
<div id="toast">Tersalin</div>

<!-- footer -->
<footer>© 2025 by Renz. All rights reserved.</footer>

<script>
/* ==========================
  GANTI dengan nilai Supabase mu
========================== */
const supabaseUrl = "https://ovocnshoodsjytoeahpy.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92b2Nuc2hvb2Rzanl0b2VhaHB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxOTM2NDEsImV4cCI6MjA3Mzc2OTY0MX0.r-uug7AzRu5LmMWSU5zGquUbxydgiBk6qtbu5VfBOlg";

/* buat client dengan benar (nama client: supabaseClient) */
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

/* tambahan: cek session saat load halaman (menggunakan supabaseClient yang sudah dideklarasikan) */
(async () => {
  try {
    const { data: { session }, error } = await supabaseClient.auth.getSession();
    if (error) {
      console.error('getSession error:', error);
    }
    if (!session) {
      window.location.href = 'index.html';
    }
  } catch (err) {
    console.error('Session check failed', err);
  }
})();

/* state */
let currentUser = null;
let editId = null;

/* deteksi Android (user-agent) */
const isAndroid = /Android/i.test(navigator.userAgent);
const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

/* elemen */
const menuBtn = document.getElementById('menuBtn');
const logoThemeToggle = document.getElementById('logoThemeToggle');
const brandLogoImg = document.getElementById('brandLogoImg');
const sidebar = document.getElementById('sidebar');
const sidebarGrid = document.getElementById('sidebarGrid');
const sidebarBackBtn = document.getElementById('sidebarBackBtn');
const profileBtn = document.getElementById('profileBtn');
const profileMenu = document.getElementById('profileMenu');
const profilePic = document.getElementById('profilePic');
const profileNameEl = document.getElementById('profileName');
const viewOverlay = document.getElementById('viewOverlay');
const viewTitle = document.getElementById('viewTitle');
const viewDate = document.getElementById('viewDate');
const viewContent = document.getElementById('viewContent');
const viewCopyBtn = document.getElementById('viewCopyBtn');
const toastEl = document.getElementById('toast');
const saveProfileBtn = document.getElementById('saveProfileBtn');
const logoutBtn = document.getElementById('logoutBtn');
const savePasteBtn = document.getElementById('savePasteBtn');
const clearFormBtn = document.getElementById('clearFormBtn');
const closeViewBtn = document.getElementById('closeViewBtn');

const shareModal = document.getElementById('shareModal');
const shareGrid = document.getElementById('shareGrid');
const shareDesc = document.getElementById('shareDesc');
const closeShareModal = document.getElementById('closeShareModal');
const viewShareBtn = document.getElementById('viewShareBtn');
const viewShareInline = document.getElementById('viewShareInline');

/* helper - avatar public url */
function avatarUrlFor(path){
  if(!path) return '';
  try{
    const res = supabaseClient.storage.from('avatars').getPublicUrl(path);
    return (res && res.data && res.data.publicUrl) ? res.data.publicUrl : '';
  }catch(e){
    console.error('avatarUrlFor error', e);
    return '';
  }
}

/* debug helper to show structured error */
function showSupabaseError(tag, err){
  console.error(tag, err);
  try{
    const msg = err?.message || err?.error || JSON.stringify(err);
    alert(`${tag}\n${msg}`);
  }catch(e){
    alert(tag + ' (lihat console)');
  }
}

/* --- logo theme handling: use provided image and simple dark tweak --- */
const USER_LOGO = 'https://pomf2.lain.la/f/w53ncnd.png';
function setLogoTheme(theme){
  brandLogoImg.src = USER_LOGO;
  const wrapper = brandLogoImg.parentElement;
  if(theme === 'dark'){
    wrapper.classList.add('dark');
    logoThemeToggle.innerHTML = `\n      <svg viewBox="0 0 24 24" aria-hidden="true">\n        <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" fill="currentColor"/>\n      </svg>`;
    logoThemeToggle.setAttribute('aria-pressed','true');
  } else {
    wrapper.classList.remove('dark');
    logoThemeToggle.innerHTML = `\n      <svg viewBox="0 0 24 24" aria-hidden="true">\n        <circle cx="12" cy="12" r="4" fill="currentColor"/>\n      </svg>`;
    logoThemeToggle.setAttribute('aria-pressed','false');
  }
  localStorage.setItem('snipbinLogoTheme', theme);
}
(function initLogoTheme(){
  const saved = localStorage.getItem('snipbinLogoTheme') || 'light';
  setLogoTheme(saved);
})();
logoThemeToggle.addEventListener('click', ()=>{
  const cur = localStorage.getItem('snipbinLogoTheme') || 'light';
  setLogoTheme(cur === 'light' ? 'dark' : 'light');
});

/* init */
async function init(){
  try{
    sidebarBackBtn.style.display = 'none';

    const { data: { session }, error } = await supabaseClient.auth.getSession();
    if(error){ console.error('getSession error', error); }
    if(!session || !session.user){ window.location.href = 'index.html'; return; }
    currentUser = session.user;
    await loadProfile();
    await renderPastes();
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    if(id) openPasteView(id);
  }catch(err){
    console.error('init error', err);
    window.location.href = 'index.html';
  }
}
init();

/* UI toggles */
menuBtn.addEventListener('click', (e)=>{
  e.stopPropagation();
  toggleSidebar();
});
sidebarBackBtn.addEventListener('click', (e) => { e.stopPropagation(); if(isSidebarOpen()){ closeSidebar(); } else { if(window.history.length > 1) window.history.back(); } });

document.addEventListener('click', (e)=>{
  if(!sidebar.contains(e.target) && e.target !== menuBtn) closeSidebar();
  if(!profileMenu.contains(e.target) && e.target !== profileBtn && !profileBtn.contains(e.target)) profileMenu.style.display = 'none';
});
window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ closeSidebar(); profileMenu.style.display='none'; closeView(); closeShare(); } });

function toggleSidebar(){ if(isSidebarOpen()) closeSidebar(); else openSidebar(); }
function isSidebarOpen(){ return (sidebar.style.left === '0px' || window.getComputedStyle(sidebar).left === '0px' || sidebar.classList.contains('open')); }
function openSidebar(){ sidebar.style.left = '0px'; sidebar.classList.add('open'); if(isAndroid){ sidebarBackBtn.style.display = 'inline-flex'; } else { sidebarBackBtn.style.display = 'none'; } }
function closeSidebar(){ if(window.matchMedia('(max-width:760px)').matches){ sidebar.style.left = '-100%'; } else { sidebar.style.left = '-360px'; } sidebar.classList.remove('open'); sidebarBackBtn.style.display = 'none'; }

/* profile */
profileBtn.addEventListener('click', (e)=>{ e.stopPropagation(); profileMenu.style.display = profileMenu.style.display === 'block' ? 'none' : 'block'; });

function isAllowedTarget(el){
  if(!el) return false;
  const ALLOWED = ['button','input','textarea','select','a.link-share'];
  let cur = el;
  while(cur && cur !== document){
    try{ if(cur.matches && cur.matches(ALLOWED.join(','))) return true; }catch(e){}
    if(cur.id === 'menuBtn' || cur.id === 'profileBtn') return true;
    if(cur.classList && cur.classList.contains('btn')) return true;
    cur = cur.parentElement;
  }
  return false;
}
document.addEventListener('pointerdown', function(e){ if(isAllowedTarget(e.target)) return; }, true);
document.addEventListener('click', function(e){ if(isAllowedTarget(e.target)) return; }, true);
document.addEventListener('contextmenu', (e)=>{ if(e.target.closest && e.target.closest('pre')) e.preventDefault(); });

/* profile load & update */
async function loadProfile(){
  try{
    const { data, error } = await supabaseClient.from('profiles').select('*').eq('id', currentUser.id).single();
    if(error && error.code !== 'PGRST116'){ console.error('loadProfile error', error); }
    if(!data){
      const insertPayload = { id: currentUser.id, full_name: currentUser.user_metadata?.full_name || 'User', avatar_url: '' };
      const { error: insErr } = await supabaseClient.from('profiles').insert([insertPayload]);
      if(insErr) console.error('insert profile err', insErr);
      profileNameEl.textContent = currentUser.user_metadata?.full_name || 'User';
      profilePic.src = '';
    } else {
      profileNameEl.textContent = data.full_name || 'User';
      profilePic.src = data.avatar_url ? avatarUrlFor(data.avatar_url) : '';
    }
  }catch(err){ console.error('loadProfile catch', err); }
}

saveProfileBtn.addEventListener('click', updateProfile);
logoutBtn.addEventListener('click', logout);

async function updateProfile(){
  const newName = document.getElementById('newName').value.trim();
  const file = document.getElementById('newPhoto').files[0];
  let avatar_path;
  try{
    if(file){
      const ext = file.name.split('.').pop();
      const filename = `${currentUser.id}_${Date.now()}.${ext}`;
      const { data, error } = await supabaseClient.storage.from('avatars').upload(filename, file, { upsert: true });
      if(error){
        console.error('storage upload error', error);
        showSupabaseError('Upload foto gagal:', error);
        return;
      }
      avatar_path = data.path;
    }
    const payload = { id: currentUser.id };
    if(newName) payload.full_name = newName;
    if(avatar_path) payload.avatar_url = avatar_path;
    const { error } = await supabaseClient.from('profiles').upsert(payload);
    if(error){
      console.error('upsert profile error', error);
      showSupabaseError('Gagal menyimpan profil:', error);
      return;
    }
    await loadProfile();
    document.getElementById('newName').value = '';
    document.getElementById('newPhoto').value = '';
    profileMenu.style.display = 'none';
    showToast('Profil diperbarui');
  }catch(e){
    console.error('updateProfile error', e);
    showSupabaseError('Terjadi kesalahan saat menyimpan profil.', e);
  }
}

/* paste CRUD */
savePasteBtn.addEventListener('click', savePaste);
clearFormBtn.addEventListener('click', clearForm);

async function savePaste(){
  const title = document.getElementById('pasteTitle').value.trim();
  const content = document.getElementById('pasteContent').value.trim();
  const privacy = document.getElementById('pastePrivacy').value;
  const language = document.getElementById('pasteLanguage').value;
  if(!title){ alert('Judul wajib diisi!'); return; }
  if(!content){ alert('Isi teks paste terlebih dahulu'); return; }
  try{
    if(editId){
      const { error } = await supabaseClient.from('pastes').update({ title, content, privacy, language }).eq('id', editId);
      if(error){
        console.error('update paste error', error);
        showSupabaseError('Gagal update paste:', error);
        return;
      }
      editId = null;
    } else {
      const { data, error } = await supabaseClient.from('pastes').insert([{ user_id: currentUser.id, title, content, privacy, language }]).select().single();
      if(error){
        console.error('insert paste error', error);
        showSupabaseError('Gagal menyimpan paste:', error);
        return;
      }
    }
    clearForm();
    await renderPastes();
    showToast('Paste tersimpan');
  }catch(err){
    console.error('savePaste catch', err);
    showSupabaseError('Terjadi kesalahan saat menyimpan.', err);
  }
}

function clearForm(){
  editId = null;
  document.getElementById('pasteTitle').value='';
  document.getElementById('pasteContent').value='';
  document.getElementById('pastePrivacy').value='public';
  document.getElementById('pasteLanguage').value='';
}

/* render pastes INTO sidebarGrid with auto date from created_at */
async function renderPastes(){
  try{
    const { data: pastes, error } = await supabaseClient
      .from('pastes')
      .select('id,user_id,title,privacy,language,created_at')
      .or(`privacy.eq.public,user_id.eq.${currentUser.id}`)
      .order('created_at', { ascending: false });
    if(error){ console.error(error); return; }

    sidebarGrid.innerHTML = '';

    pastes.forEach(p => {
      const card = document.createElement('div');
      card.className = 'paste-card';

      const h = document.createElement('h3');
      h.innerHTML = `<span>${escapeHtml(p.title || '—')}</span>`;

      const ownerActions = document.createElement('span');
      ownerActions.style.display = 'flex';
      ownerActions.style.gap = '6px';
      if(p.user_id === currentUser.id){
        const editBtn = document.createElement('button');
        editBtn.className = 'btn edit';
        editBtn.title = 'Edit';
        editBtn.setAttribute('aria-label','Edit');
        editBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>';
        editBtn.onclick = (ev)=>{ ev.stopPropagation(); editPaste(p.id); };
        const delBtn = document.createElement('button');
        delBtn.className = 'btn delete';
        delBtn.title = 'Hapus';
        delBtn.setAttribute('aria-label','Hapus');
        delBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>';
        delBtn.onclick = (ev)=>{ ev.stopPropagation(); deletePaste(p.id); };
        ownerActions.appendChild(editBtn);
        ownerActions.appendChild(delBtn);
      }
      h.appendChild(ownerActions);
      card.appendChild(h);

      const dateEl = document.createElement('div');
      const d = p.created_at ? new Date(p.created_at) : null;
      if(d && !isNaN(d)) {
        dateEl.textContent = `Disimpan: ${d.toLocaleString('id-ID', { dateStyle:'medium', timeStyle:'short' })}`;
      } else {
        dateEl.textContent = 'Disimpan: -';
      }
      dateEl.className = 'meta';
      card.appendChild(dateEl);

      const contentPre = document.createElement('pre');
      contentPre.className = `language-${p.language || ''}`;
      contentPre.style.display = 'none';
      contentPre.textContent = '';
      card.appendChild(contentPre);

      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.gap = '8px';
      row.style.marginTop = '8px';
      row.style.alignItems = 'center';

      const eyeBtn = document.createElement('button');
      eyeBtn.className = 'btn eye';
      eyeBtn.title = 'Tampilkan isi';
      eyeBtn.setAttribute('aria-label','Tampilkan isi');
      eyeBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12z"/><circle cx="12" cy="12" r="3"/></svg>';
      eyeBtn.onclick = async (ev)=>{
        ev.stopPropagation();
        try{
          if(contentPre.dataset.loaded){
            if(contentPre.style.display === 'none'){
              contentPre.style.display = 'block';
              Prism.highlightElement(contentPre);
            } else {
              contentPre.style.display = 'none';
            }
            return;
          }
          const { data: fetched, error: fetchErr } = await supabaseClient.from('pastes').select('content,privacy,user_id,language').eq('id', p.id).single();
          if(fetchErr){ showSupabaseError('Gagal mengambil isi paste:', fetchErr); return; }
          if(fetched.privacy === 'private' && fetched.user_id !== currentUser.id){ alert('Paste ini private.'); return; }
          contentPre.textContent = fetched.content || '';
          contentPre.className = `language-${fetched.language || ''}`;
          contentPre.dataset.loaded = '1';
          contentPre.style.display = 'block';
          Prism.highlightElement(contentPre);
        }catch(err){ console.error('eyeBtn error', err); }
      };

      const openBtn = document.createElement('button');
      openBtn.className = 'btn open';
      openBtn.title = 'Buka';
      openBtn.setAttribute('aria-label','Buka');
      openBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M15 12a3 3 0 1 0-3 3"/><path d="M2 12s2-4 10-4 10 4 10 4-2 4-10 4S2 12 2 12z"/></svg>';
      openBtn.onclick = (ev)=>{ ev.stopPropagation(); openPasteView(p.id); closeSidebar(); };

      const copyBtn = document.createElement('button');
      copyBtn.className = 'btn copy';
      copyBtn.title = 'Salin';
      copyBtn.setAttribute('aria-label','Salin');
      copyBtn.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
      copyBtn.onclick = async (ev)=>{ ev.stopPropagation(); copyFromLazy(contentPre, p.id); };

      // share button (buka modal share sheet)
      const shareBtn = document.createElement('button');
      shareBtn.className = 'btn open';
      shareBtn.title = 'Share';
      shareBtn.setAttribute('aria-label','Share');
      shareBtn.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7"/><path d="M12 3v10"/><path d="M8 7l4-4 4 4"/></svg>';
      const url = new URL(window.location.href);
      url.searchParams.set('id', p.id);
      shareBtn.onclick = (ev)=>{ ev.stopPropagation(); openShare(url.toString(), p.title || '(tanpa judul)', p.id); };

      row.appendChild(eyeBtn);
      row.appendChild(openBtn);
      row.appendChild(copyBtn);
      row.appendChild(shareBtn);
      card.appendChild(row);

      sidebarGrid.appendChild(card);
    });

  }catch(err){ console.error('renderPastes error', err); }
}

/* lazy copy: ambil content jika belum dimuat, lalu salin */
async function copyFromLazy(contentPre, pasteId){
  try{
    if(contentPre.dataset.loaded){
      await copyToClipboard(contentPre.textContent);
      return;
    }
    const { data: fetched, error: fetchErr } = await supabaseClient.from('pastes').select('content,privacy,user_id,language').eq('id', pasteId).single();
    if(fetchErr){ showSupabaseError('Gagal mengambil isi paste:', fetchErr); return; }
    if(fetched.privacy === 'private' && fetched.user_id !== currentUser.id){ alert('Paste ini private.'); return; }
    contentPre.textContent = fetched.content || '';
    contentPre.className = `language-${fetched.language || ''}`;
    contentPre.dataset.loaded = '1';
    await copyToClipboard(fetched.content || '');
  }catch(err){ console.error('copyFromLazy error', err); alert('Gagal menyalin paste.'); }
}

/* edit */
async function editPaste(id){
  try{
    const { data, error } = await supabaseClient.from('pastes').select('*').eq('id', id).single();
    if(error){ showSupabaseError('Gagal ambil paste:', error); return; }
    if(data.user_id !== currentUser.id){ alert('Hanya pembuat yang bisa edit'); return; }
    editId = id;
    document.getElementById('pasteTitle').value = data.title || '';
    document.getElementById('pasteContent').value = data.content || '';
    document.getElementById('pastePrivacy').value = data.privacy || 'public';
    document.getElementById('pasteLanguage').value = data.language || '';
    window.scrollTo({ top: 0, behavior: 'smooth' });
    closeSidebar();
  }catch(err){ console.error('editPaste error', err); }
}

/* delete */
async function deletePaste(id){
  if(!confirm('Hapus paste ini?')) return;
  try{
    const { data, error } = await supabaseClient.from('pastes').select('user_id').eq('id', id).single();
    if(error){ showSupabaseError('Gagal:', error); return; }
    if(data.user_id !== currentUser.id){ alert('Hanya pembuat yang bisa hapus'); return; }
    await supabaseClient.from('pastes').delete().eq('id', id);
    await renderPastes();
    showToast('Paste dihapus');
  }catch(err){ console.error('deletePaste error', err); }
}

/* open paste view by id (date shown too) */
async function openPasteView(id){
  try{
    const { data, error } = await supabaseClient.from('pastes').select('*').eq('id', id).single();
    if(error){ showSupabaseError('Paste tidak ditemukan', error); return; }
    if(data.privacy === 'private' && data.user_id !== currentUser.id){ alert('Paste ini private.'); return; }
    viewTitle.textContent = data.title || '(Tanpa Judul)';
    const d = data.created_at ? new Date(data.created_at) : null;
    if(d && !isNaN(d)) {
      viewDate.textContent = d.toLocaleString('id-ID', { dateStyle:'medium', timeStyle:'short' });
    } else {
      viewDate.textContent = '';
    }
    viewContent.className = `language-${data.language || ''}`;
    viewContent.textContent = data.content;
    Prism.highlightElement(viewContent);
    viewOverlay.style.display = 'flex';
    const newUrl = new URL(window.location.href);
    newUrl.searchParams.set('id', id);
    window.history.replaceState(null, '', newUrl.toString());

    // wire view share button to open share modal for this paste
    const shareUrl = new URL(window.location.href);
    shareUrl.searchParams.set('id', id);
    viewShareBtn.onclick = (ev) => { ev.stopPropagation(); openShare(shareUrl.toString(), data.title || '(tanpa judul)', data.id); };
    viewShareInline.onclick = (ev) => { ev.stopPropagation(); openShare(shareUrl.toString(), data.title || '(tanpa judul)', data.id); };
  }catch(err){ console.error('openPasteView error', err); }
}

function closeView(){
  viewOverlay.style.display = 'none';
  const newUrl = new URL(window.location.href);
  newUrl.searchParams.delete('id');
  window.history.replaceState(null, '', newUrl.toString());
}

/* copy helper */
async function copyToClipboard(text){
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(text);
    } else {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
    }
    showToast('Teks disalin');
  }catch(err){
    console.error('copy failed', err);
    alert('Gagal menyalin');
  }
}

/* wire view copy/close button */
viewCopyBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); copyToClipboard(viewContent.textContent); });
closeViewBtn.addEventListener('click', closeView);

/* toast */
let toastTimer = null;
function showToast(msg = 'Tersalin'){
  toastEl.textContent = msg;
  toastEl.style.display = 'block';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ toastEl.style.display = 'none'; }, 1600);
}

/* logout */
async function logout(){ await supabaseClient.auth.signOut(); window.location.href = 'index.html'; }

/* util */
function escapeHtml(s){ return String(s || '').replace(/[&<>\"']/g, function(m){return ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;"})[m];}); }

/* -----------------------
   Share modal logic (menggunakan PNG logos, bukan SVG)
   ----------------------- */

/* PNG icons (raster) - sumber: Icons8 (raster PNG) */
const ICON_WHATSAPP = 'https://pomf2.lain.la/f/4lw8i68e.png';
const ICON_WAB = 'https://pomf2.lain.la/f/d602pr5f.png';
const ICON_TELEGRAM = 'https://pomf2.lain.la/f/butk832.png';
const ICON_INSTAGRAM = 'https://pomf2.lain.la/f/1wk4tzud.png';
const ICON_DISCORD = 'https://pomf2.lain.la/f/tiuhix5e.png';
const ICON_FACEBOOK = 'https://pomf2.lain.la/f/odyivtg.png';
const ICON_COPY = 'https://img.icons8.com/color/96/000000/copy.png';
const ICON_NATIVE = 'https://pomf2.lain.la/f/g432x4th.png';

/* helper to open external windows with graceful fallback when popup is blocked:
   try opening in new tab; if blocked, copy url and notify user */
function openOrCopy(url, fallbackMessage = 'Tautan disalin. Tempel di aplikasi yang Anda inginkan.'){
  try{
    const win = window.open(url, '_blank');
    if(!win || win.closed || typeof win.closed === 'undefined'){
      // popup blocked -> salin ke clipboard
      copyToClipboard(url);
      alert(fallbackMessage);
    }
  }catch(e){
    copyToClipboard(url);
    alert(fallbackMessage);
  }
}

function openShare(url, title, pasteId){
  shareGrid.innerHTML = ''; // reset
  shareDesc.textContent = title || 'Bagikan tautan ini';

  const shareText = `${title}\n${url}`;

  function addShareItem({ key, label, imgSrc, bgClass, onClick }){
    const item = document.createElement('div');
    item.className = 'share-item';
    const btn = document.createElement('button');
    btn.className = 'share-btn ' + (bgClass || '');
    btn.title = label;
    btn.type = 'button';
    // use <img> for raster logo
    const img = document.createElement('img');
    img.src = imgSrc;
    img.alt = label;
    img.loading = 'lazy';
    btn.appendChild(img);
    btn.addEventListener('click', onClick);
    const lbl = document.createElement('div');
    lbl.className = 'share-label';
    lbl.textContent = label;
    item.appendChild(btn);
    item.appendChild(lbl);
    shareGrid.appendChild(item);
  }

  // Add items (Salin, WhatsApp, WA Bisnis, Telegram, Instagram, Discord, Facebook, Lainnya)
  addShareItem({
    key:'copy',
    label:'Salin',
    imgSrc: ICON_COPY,
    bgClass:'icon-bg-copy',
    onClick: async () => { await copyToClipboard(url); }
  });

  addShareItem({
    key:'whatsapp',
    label:'WhatsApp',
    imgSrc: ICON_WHATSAPP,
    bgClass:'icon-bg-wa',
    onClick: () => {
      const text = encodeURIComponent(shareText);
      // gunakan wa.me sehingga tidak diarahkan ke Play Store / App Store
      const waUrl = `https://wa.me/?text=${text}`;
      openOrCopy(waUrl, 'Tidak bisa membuka WhatsApp, tautan disalin.');
    }
  });

  addShareItem({
    key:'wab',
    label:'WA Bisnis',
    imgSrc: ICON_WAB,
    bgClass:'icon-bg-wab',
    onClick: () => {
      const text = encodeURIComponent(shareText);
      const wabUrl = `https://wa.me/?text=${text}`; // web link works for both
      openOrCopy(wabUrl, 'Tidak bisa membuka WhatsApp Business, tautan disalin.');
    }
  });

  addShareItem({
    key:'telegram',
    label:'Telegram',
    imgSrc: ICON_TELEGRAM,
    bgClass:'icon-bg-tg',
    onClick: () => {
      const text = encodeURIComponent(shareText);
      if(isIOS || isAndroid){
        try{
          window.location.href = `tg://msg?text=${text}`;
          setTimeout(()=> openOrCopy(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`, 'Tidak bisa membuka Telegram, tautan disalin.'), 700);
        }catch(e){
          openOrCopy(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`, 'Tidak bisa membuka Telegram, tautan disalin.');
        }
      } else {
        openOrCopy(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`, 'Tidak bisa membuka Telegram, tautan disalin.');
      }
    }
  });

  addShareItem({
    key:'instagram',
    label:'Instagram',
    imgSrc: ICON_INSTAGRAM,
    bgClass:'icon-bg-mail',
    onClick: async () => {
      await copyToClipboard(url);
      openOrCopy('https://www.instagram.com/', 'Tidak bisa membuka Instagram, tautan disalin.');
      alert('Tautan disalin. Buka Instagram lalu tempel di DM atau bio.');
    }
  });

  addShareItem({
    key:'discord',
    label:'Discord',
    imgSrc: ICON_DISCORD,
    bgClass:'icon-bg-dc',
    onClick: () => {
      openOrCopy('https://discord.com/', 'Tidak bisa membuka Discord, tautan disalin.');
    }
  });

  addShareItem({
    key:'facebook',
    label:'Facebook',
    imgSrc: ICON_FACEBOOK,
    bgClass:'icon-bg-fb',
    onClick: () => {
      openOrCopy(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, 'Tidak bisa membuka Facebook, tautan disalin.');
    }
  });

  addShareItem({
    key:'native',
    label:'Lainnya',
    imgSrc: ICON_NATIVE,
    bgClass:'',
    onClick: async () => {
      if(navigator.share){
        try{
          await navigator.share({ title: title, text: title, url: url });
        }catch(e){
          console.error('native share cancelled', e);
        }
      } else {
        await copyToClipboard(url);
        alert('Tautan disalin. Tempel di aplikasi yang Anda inginkan.');
      }
    }
  });

  // show modal
  shareModal.classList.add('open');
  shareModal.setAttribute('aria-hidden', 'false');
}

/* close share modal */
function closeShare(){
  shareModal.classList.remove('open');
  shareModal.setAttribute('aria-hidden', 'true');
}
closeShareModal.addEventListener('click', closeShare);

/* close share modal when tapping outside (small UX improvement) */
document.addEventListener('click', (e) => {
  if(shareModal.classList.contains('open')){
    const inside = shareModal.contains(e.target);
    const isShareBtn = e.target.closest && e.target.closest('.btn.open');
    if(!inside && !isShareBtn){
      closeShare();
    }
  }
});

/* small safety: close share modal on escape */
window.addEventListener('keydown', (e) => {
  if(e.key === 'Escape') closeShare();
});
</script>
</body>
</html>
