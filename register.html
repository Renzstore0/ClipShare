<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SnipBin – Daftar</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{--accent:#6d28d9;--bg1:#eef2ff;--bg2:#f7f9ff}
  *{box-sizing:border-box}
  body{
    font-family:Inter,system-ui,Arial,sans-serif;
    background:linear-gradient(180deg,var(--bg1),var(--bg2));
    margin:0;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;
  }
  .wrap{width:100%;max-width:420px}
  .card{background:#fff;border-radius:14px;padding:28px;border:1px solid rgba(110,76,246,0.06);box-shadow:0 12px 30px rgba(13,18,35,0.08)}
  .brand{text-align:center;margin-bottom:16px}
  .logo{width:52px;height:52px;margin:0 auto 10px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#a78bfa);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
  h2{margin:0;color:var(--accent);font-size:1.35rem}
  p.lead{margin:8px 0 18px;color:#555;font-size:14px}

  .input-group{position:relative;margin-bottom:14px}
  input{
    width:100%;padding:12px 44px 12px 12px;border-radius:10px;border:1px solid #e5e7eb;font-size:15px;outline:none;background:#fff;transition:border-color .12s, box-shadow .12s;line-height:1.2;
  }
  input.with-eye{padding-right:52px}
  input:focus{box-shadow:0 0 0 4px rgba(109,40,217,0.12);border-color:var(--accent)}

  .toggle-password{position:absolute;right:8px;top:50%;transform:translateY(-50%);height:36px;width:36px;border-radius:8px;border:0;background:transparent;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;color:#6b7280}
  .toggle-password:active{transform:translateY(-50%) scale(.97)}
  .toggle-password svg{display:block;pointer-events:none;transform:translateY(2px)}

  .primary{width:100%;padding:12px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:700;cursor:pointer;font-size:15px;transition:transform .08s ease, box-shadow .08s ease}
  .primary:active{transform:translateY(1px)}
  .primary[disabled]{opacity:.6;cursor:not-allowed}

  .muted{font-size:13px;color:#6b7280;text-align:center;margin-top:12px}
  a.link{color:var(--accent);font-weight:600;text-decoration:none}

  #authMsg{margin-top:12px;text-align:center;font-weight:700;color:#dc2626;min-height:20px}
  #authMsg.success{color:#16a34a}

  footer{margin-top:18px;font-size:12px;color:#6b7280;text-align:center}
  @media (max-width:420px){.card{padding:20px}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="form" aria-labelledby="register-heading">
      <div class="brand">
        <div class="logo">SB</div>
        <h2 id="register-heading">SnipBin – Daftar</h2>
        <p class="lead">Buat akun baru. Aman, cepat, ringan.</p>
      </div>

      <div class="input-group">
        <label for="name" class="sr-only">Nama</label>
        <input id="name" type="text" placeholder="Nama lengkap" autocomplete="name" />
      </div>

      <div class="input-group">
        <label for="email" class="sr-only">Email</label>
        <input id="email" type="email" placeholder="contoh@gmail.com" autocomplete="email" inputmode="email" />
      </div>

      <div class="input-group">
        <label for="password" class="sr-only">Password</label>
        <input id="password" class="with-eye" type="password" placeholder="Masukkan password" autocomplete="new-password" />
        <button id="togglePassword" class="toggle-password" aria-pressed="false" aria-label="Tampilkan password" type="button">
          <svg id="eyeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12z"></path><circle cx="12" cy="12" r="3"></circle></svg>
        </button>
      </div>

      <button id="btnRegister" class="primary" type="button">Daftar</button>

      <p id="authMsg" aria-live="polite"></p>

      <div class="muted">Sudah punya akun? <a class="link" href="index.html">Login</a></div>
    </div>

    <footer>© 2025 by Renz. All rights reserved.</footer>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Supabase config (samakan dengan login)
  const supabaseUrl = "https://ovocnshoodsjytoeahpy.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92b2Nuc2hvb2Rzanl0b2VhaHB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxOTM2NDEsImV4cCI6MjA3Mzc2OTY0MX0.r-uug7AzRu5LmMWSU5zGquUbxydgiBk6qtbu5VfBOlg";
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  const nameInput = document.getElementById('name');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const btn = document.getElementById('btnRegister');
  const togglePassword = document.getElementById('togglePassword');
  const authMsg = document.getElementById('authMsg');

  // global toast element
  const toast = document.createElement('div');
  toast.id = 'globalToast';
  toast.setAttribute('role', 'status');
  toast.setAttribute('aria-live', 'polite');
  toast.style.position = 'fixed';
  toast.style.top = '18px';
  toast.style.left = '50%';
  toast.style.transform = 'translateX(-50%) translateY(-10px)';
  toast.style.padding = '12px 16px';
  toast.style.borderRadius = '10px';
  toast.style.boxShadow = '0 8px 30px rgba(13,18,35,0.12)';
  toast.style.background = '#111827';
  toast.style.color = '#fff';
  toast.style.fontWeight = '700';
  toast.style.zIndex = 9999;
  toast.style.opacity = '0';
  toast.style.pointerEvents = 'none';
  toast.style.transition = 'opacity 260ms ease, transform 260ms ease';
  document.body.appendChild(toast);

  let toastTimer = null;
  function showToast(message = '', isError = true, duration = 3000){
    if(toastTimer) { clearTimeout(toastTimer); toastTimer = null; }
    toast.textContent = message;
    toast.style.background = isError ? '#111827' : '#059669';
    toast.style.opacity = '1';
    toast.style.pointerEvents = 'auto';
    toast.style.transform = 'translateX(-50%) translateY(0)';
    toastTimer = setTimeout(()=>{
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(-50%) translateY(-10px)';
      toastTimer = null;
    }, duration);
  }

  function clearToast(){
    if(toastTimer) { clearTimeout(toastTimer); toastTimer = null; }
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(-50%) translateY(-10px)';
  }

  function setLoading(on = true){
    btn.disabled = on;
    btn.style.opacity = on ? 0.7 : 1;
    btn.textContent = on ? 'Memproses...' : 'Daftar';
  }

  async function register(){
    clearToast();
    authMsg.textContent = '';
    const name = nameInput.value.trim();
    const email = emailInput.value.trim();
    const password = passwordInput.value;

    if(!name){ showToast('Nama wajib diisi!', true); nameInput.focus(); return; }
    if(!email){ showToast('Email wajib diisi!', true); emailInput.focus(); return; }
    if(!password){ showToast('Password wajib diisi!', true); passwordInput.focus(); return; }
    if(password.length < 6){ showToast('Password minimal 6 karakter!', true); passwordInput.focus(); return; }

    setLoading(true);

    try{
      // sign up
      const { data, error } = await supabaseClient.auth.signUp({ email, password });
      if(error){
        const msg = (error?.message || '').toLowerCase();
        if(msg.includes('already registered') || msg.includes('user already exists') || msg.includes('duplicate')){
          showToast('Email sudah terdaftar!', true);
        }else{
          showToast('Pendaftaran gagal: ' + (error.message || error), true);
        }
        setLoading(false);
        return;
      }

      // Jika user langsung tersedia (tanpa verifikasi), upsert profile.
      try{
        const userId = data?.user?.id;
        if(userId){
          await supabaseClient.from('profiles').upsert({ id: userId, full_name: name });
        }
      }catch(e){
        // jangan gagal total jika upsert profile gagal
        console.error('upsert profile error', e);
      }

      // Jika Supabase mengirim email verifikasi, beri tahu user untuk cek email.
      if(data?.user){
        showToast('Pendaftaran berhasil. Mengalihkan...', false);
        setTimeout(()=> window.location.href = 'app.html', 800);
      }else{
        // kasus: user belum aktif/harus verifikasi email
        showToast('Pendaftaran berhasil. Cek email untuk verifikasi.', false, 5000);
        // arahkan ke halaman login untuk user login setelah verifikasi
        setTimeout(()=> window.location.href = 'index.html', 1400);
      }
    }catch(e){
      console.error(e);
      showToast('Terjadi kesalahan. Coba lagi.', true);
      setLoading(false);
    }
  }

  // toggle eye
  const svgEye = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12z"></path><circle cx="12" cy="12" r="3"></circle></svg>';
  const svgEyeOff = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0112 19c-4.97 0-9-3.58-10-7a13.89 13.89 0 012.4-4.02M9.88 9.88A3 3 0 0115 12"/><path d="M3 3l18 18"/></svg>';
  let visible = false;
  function setEye(v){
    visible = v;
    passwordInput.type = visible ? 'text' : 'password';
    togglePassword.setAttribute('aria-pressed', String(visible));
    togglePassword.setAttribute('aria-label', visible ? 'Sembunyikan password' : 'Tampilkan password');
    togglePassword.innerHTML = visible ? svgEyeOff : svgEye;
    if(visible) passwordInput.focus();
  }
  setEye(false);
  togglePassword.addEventListener('click', ()=> setEye(!visible));

  // event handlers
  btn.addEventListener('click', register);
  document.addEventListener('keydown', (e) => {
    if(e.key === 'Enter' && (document.activeElement === nameInput || document.activeElement === emailInput || document.activeElement === passwordInput)){
      register();
    }
  });
});
</script>
</body>
</html>
